before_script:
  - sudo apt-get -y install build-essential cmake pkg-config libboost-serialization-dev libboost-program-options-dev libboost-filesystem-dev libboost-graph-dev libopencv-dev qtbase5-dev qtbase5-dev-tools libglibmm-2.4-dev libcgal-dev geomview

stages:
  - build
  # TODO add tests
  #- test
  - deploy

# https://docs.gitlab.com/ee/ci/yaml/README.html#special-yaml-features
.job_template: &job_definition
  stage: build
  script:
    - if [ -d build/ ]; then rm -rf build/ ; fi
    - mkdir build/ && cd build/
    - cmake -DWITH_TESTS=OFF -DWITH_GUI=$WITH_GUI -DLIBUIPF_WITH_TESTS=OFF -DWITH_OPENCV=$WITH_OPENCV -DLIBUIPF_WITH_OPENCV=$WITH_OPENCV -DCMAKE_INSTALL_PREFIX=`pwd`/../prefix ../code
    - make -j 4
    - make install
  artifacts:
    expire_in: 1 week
    paths:
      - prefix/

build-uipf-with-cv:
  <<: *job_definition
  variables:
    WITH_OPENCV: 'ON'
    WITH_GUI: 'OFF'

build-uipf-without-cv:
  <<: *job_definition
  variables:
    WITH_OPENCV: 'OFF'
    WITH_GUI: 'OFF'

build-uipf-gui-with-cv:
  <<: *job_definition
  variables:
    WITH_OPENCV: 'ON'
    WITH_GUI: 'ON'

build-uipf-gui-without-cv:
  <<: *job_definition
  variables:
    WITH_OPENCV: 'OFF'
    WITH_GUI: 'ON'

deploy:
  stage: deploy
  script:
    # temporary solution for sharing uipf artifacts
    - rm -rf /tmp/uipf-prefix
    - rsync -a prefix/ /tmp/uipf-prefix
    - find /tmp/uipf-prefix |sort
  dependencies:
    - build-uipf-with-cv

variables:
  GIT_STRATEGY: clone

# build .deb packages
preview_packages:
  stage: deploy
  script:
    - sudo debootstrap --variant=buildd jessie /tmp/${CI_BUILD_ID}-deb
    - mkdir -p /tmp/${CI_BUILD_ID}-deb/src/uipf
    - rsync -ar . /tmp/${CI_BUILD_ID}-deb/src/uipf
    - git clone git@gitlab.cebe.cc:master/packaging.git packaging
    - rsync -ar packaging/debian /tmp/${CI_BUILD_ID}-deb/src/uipf/debian
    - sudo chroot /tmp/${CI_BUILD_ID}-deb "cd src/uipf && dpkg-buildpackage -us -uc"
  environment:
    name: preview_packages
#    url: https://example.com
  when: manual
  only:
  - master
  - improved-data-model
  - packaging
